<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard — MyMortgageExpert</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #f5f5f0; color: #1B3C2D; min-height: 100vh; }

    /* ===== Login ===== */
    .login { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; }
    .login__card { background: #fff; border-radius: 16px; padding: 48px 40px; max-width: 400px; width: 100%; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }
    .login__logo { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.15rem; margin-bottom: 32px; justify-content: center; }
    .login__title { font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .login__subtitle { color: #6b7c74; font-size: 0.9rem; margin-bottom: 28px; text-align: center; }
    .login__input { width: 100%; padding: 12px 16px; border: 1.5px solid #d9ddd8; border-radius: 10px; font-size: 0.95rem; font-family: inherit; margin-bottom: 16px; transition: border-color 0.2s; outline: none; }
    .login__input:focus { border-color: #2A7D5B; }
    .login__btn { width: 100%; padding: 14px; background: #2A7D5B; color: #fff; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .login__btn:hover { background: #1B3C2D; }
    .login__error { background: #fef2f2; color: #b91c1c; padding: 10px 14px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 16px; display: none; }
    .login__error.active { display: block; }

    /* ===== Dashboard ===== */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .login.hidden { display: none; }

    .dash-header { background: #1B3C2D; color: #fff; padding: 16px 0; }
    .dash-header__inner { max-width: 1100px; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; }
    .dash-header__logo { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.1rem; }
    .dash-header__right { display: flex; align-items: center; gap: 16px; }
    .dash-header__user { font-size: 0.85rem; opacity: 0.8; }
    .dash-header__logout { background: rgba(255,255,255,0.15); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit; transition: background 0.2s; }
    .dash-header__logout:hover { background: rgba(255,255,255,0.25); }

    .dash-body { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

    .dash-tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 32px; }
    .dash-tab { padding: 12px 16px; border-radius: 10px; border: 1.5px solid #d9ddd8; background: #fff; font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; color: #1B3C2D; text-align: center; }
    .dash-tab.active { background: #1B3C2D; color: #fff; border-color: #1B3C2D; }

    .dash-panel { display: none; }
    .dash-panel.active { display: block; }

    .dash-card { background: #fff; border-radius: 16px; padding: 32px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); margin-bottom: 24px; }
    .dash-card__title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }

    .dash-table { width: 100%; border-collapse: collapse; }
    .dash-table th { text-align: left; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7c74; padding: 8px 12px; border-bottom: 2px solid #e8ebe6; }
    .dash-table td { padding: 12px; border-bottom: 1px solid #e8ebe6; font-size: 0.95rem; }
    .dash-table input { padding: 8px 12px; border: 1.5px solid #d9ddd8; border-radius: 8px; font-size: 0.95rem; font-family: inherit; width: 100%; max-width: 200px; outline: none; transition: border-color 0.2s; }
    .dash-table input:focus { border-color: #2A7D5B; }
    .dash-table input[type="number"] { max-width: 120px; }

    .dash-form { display: grid; gap: 16px; }
    .dash-form label { font-size: 0.85rem; font-weight: 600; display: block; margin-bottom: 4px; }
    .dash-form input, .dash-form select { width: 100%; padding: 10px 14px; border: 1.5px solid #d9ddd8; border-radius: 8px; font-size: 0.95rem; font-family: inherit; outline: none; transition: border-color 0.2s; }
    .dash-form input:focus { border-color: #2A7D5B; }
    .dash-form__row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .dash-btn { padding: 12px 24px; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: inherit; border: none; transition: all 0.2s; }
    .dash-btn--primary { background: #2A7D5B; color: #fff; }
    .dash-btn--primary:hover { background: #1B3C2D; }
    .dash-btn--danger { background: #fef2f2; color: #b91c1c; }
    .dash-btn--danger:hover { background: #fecaca; }
    .dash-btn--outline { background: #fff; color: #1B3C2D; border: 1.5px solid #d9ddd8; }
    .dash-btn--outline:hover { border-color: #1B3C2D; }
    .dash-btn--sm { padding: 6px 14px; font-size: 0.8rem; }

    .dash-actions { display: flex; gap: 12px; margin-top: 20px; align-items: center; }
    .dash-status { font-size: 0.85rem; color: #2A7D5B; font-weight: 500; margin-left: 8px; opacity: 0; transition: opacity 0.3s; }
    .dash-status.show { opacity: 1; }

    .lender-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #e8ebe6; }
    .lender-row:last-child { border-bottom: none; }
    .lender-row__order { color: #6b7c74; font-size: 0.85rem; min-width: 24px; }
    .lender-row input { flex: 1; padding: 8px 12px; border: 1.5px solid #d9ddd8; border-radius: 8px; font-size: 0.95rem; font-family: inherit; outline: none; }
    .lender-row input:focus { border-color: #2A7D5B; }

    .add-row { display: flex; gap: 12px; margin-top: 16px; }
    .add-row input { flex: 1; padding: 10px 14px; border: 1.5px solid #d9ddd8; border-radius: 8px; font-size: 0.95rem; font-family: inherit; outline: none; }
    .add-row input:focus { border-color: #2A7D5B; }

    .homepage-rate-row { display: grid; grid-template-columns: 1fr 100px 1fr; gap: 12px; align-items: center; padding: 10px 0; border-bottom: 1px solid #e8ebe6; }
    .homepage-rate-row:last-child { border-bottom: none; }
    .homepage-rate-row input { padding: 8px 12px; border: 1.5px solid #d9ddd8; border-radius: 8px; font-size: 0.95rem; font-family: inherit; outline: none; }
    .homepage-rate-row input:focus { border-color: #2A7D5B; }

    /* User dropdown menu */
    .dash-user-menu { position: relative; }
    .dash-user-menu__toggle { background: none; border: none; color: #fff; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 8px; font-family: inherit; transition: background 0.2s; }
    .dash-user-menu__toggle:hover { background: rgba(255,255,255,0.1); }
    .dash-user-menu__dropdown { display: none; position: absolute; right: 0; top: calc(100% + 6px); background: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); min-width: 180px; overflow: hidden; z-index: 100; }
    .dash-user-menu__dropdown.active { display: block; }
    .dash-user-menu__dropdown a { display: block; padding: 12px 16px; color: #1B3C2D; font-size: 0.9rem; text-decoration: none; transition: background 0.15s; }
    .dash-user-menu__dropdown a:hover { background: #f5f5f0; }

    /* Account panel */
    .dash-card__subtitle { color: #6b7c74; font-size: 0.85rem; margin-bottom: 20px; }
    .dash-card__back { color: #2A7D5B; font-size: 0.9rem; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; margin-bottom: 20px; }
    .dash-card__back:hover { text-decoration: underline; }
    .password-success { background: #f0fdf4; color: #166534; padding: 10px 14px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 16px; display: none; }
    .password-error { background: #fef2f2; color: #b91c1c; padding: 10px 14px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 16px; display: none; }

    /* Broker cards */
    .broker-card { border: 1.5px solid #e8ebe6; border-radius: 12px; padding: 20px; margin-bottom: 16px; position: relative; transition: border-color 0.2s; }
    .broker-card--active { border-color: #2A7D5B; background: #f0fdf4; }
    .broker-card__badge { display: inline-block; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 3px 8px; border-radius: 4px; margin-bottom: 12px; }
    .broker-card__badge--active { background: #2A7D5B; color: #fff; }
    .broker-card__badge--inactive { background: #e8ebe6; color: #6b7c74; }
    .broker-card__name { font-size: 1.05rem; font-weight: 700; margin-bottom: 8px; }
    .broker-card__detail { font-size: 0.85rem; color: #6b7c74; margin-bottom: 4px; }
    .broker-card__actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }

    /* Hamburger button - hidden on desktop */
    .dash-hamburger { display: none; background: none; border: 1.5px solid #d9ddd8; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-family: inherit; font-size: 0.9rem; font-weight: 600; color: #1B3C2D; width: 100%; text-align: left; align-items: center; justify-content: space-between; }
    .dash-hamburger svg { transition: transform 0.2s; }
    .dash-hamburger.open svg { transform: rotate(180deg); }

    @media (max-width: 600px) {
      .dash-form__row { grid-template-columns: 1fr; }
      .dash-header__inner { flex-direction: column; gap: 12px; text-align: center; }
      .homepage-rate-row { grid-template-columns: 1fr; }
      .login__card { padding: 32px 24px; }

      /* Hamburger menu for tabs */
      .dash-hamburger { display: flex; }
      .dash-tabs { display: none; flex-direction: column; gap: 4px; margin-top: 8px; margin-bottom: 32px; }
      .dash-tabs.open { display: flex; }
      .dash-tab { text-align: left; border-radius: 8px; }
    }
  </style>
</head>
<body>

  <!-- ===== LOGIN ===== -->
  <div class="login" id="loginScreen">
    <div class="login__card">
      <div class="login__logo">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <rect width="32" height="32" rx="7" fill="#1B3C2D"/>
          <path d="M7 23V13l9-5.5 9 5.5v10H7z" fill="#2A7D5B"/>
          <rect x="12.5" y="16.5" width="7" height="6.5" rx="1" fill="#F7F3EE"/>
        </svg>
        <span>MyMortgageExpert</span>
      </div>
      <h1 class="login__title">Admin Dashboard</h1>
      <p class="login__subtitle">Sign in to manage rates, broker info, and lenders.</p>
      <div class="login__error" id="loginError"></div>
      <form id="loginForm">
        <input type="email" class="login__input" id="loginEmail" placeholder="Email address" required>
        <input type="password" class="login__input" id="loginPassword" placeholder="Password" required>
        <button type="submit" class="login__btn" id="loginBtn">Sign In</button>
      </form>
      <p style="text-align:center; margin-top:16px;">
        <a href="#" id="forgotPasswordLink" style="color:#2A7D5B; font-size:0.85rem; text-decoration:none;">Forgot password?</a>
      </p>
      <div id="resetScreen" style="display:none;">
        <p style="color:#6b7c74; font-size:0.9rem; margin-bottom:16px; text-align:center;">Enter your email and we'll send you a reset link.</p>
        <div class="login__error" id="resetError"></div>
        <div id="resetSuccess" style="background:#f0fdf4; color:#166534; padding:10px 14px; border-radius:8px; font-size:0.85rem; margin-bottom:16px; display:none;"></div>
        <form id="resetForm">
          <input type="email" class="login__input" id="resetEmail" placeholder="Email address" required>
          <button type="submit" class="login__btn" id="resetBtn">Send Reset Link</button>
        </form>
        <p style="text-align:center; margin-top:16px;">
          <a href="#" id="backToLogin" style="color:#2A7D5B; font-size:0.85rem; text-decoration:none;">&larr; Back to sign in</a>
        </p>
      </div>
    </div>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div class="dashboard" id="dashboard">
    <header class="dash-header">
      <div class="dash-header__inner">
        <div class="dash-header__logo">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
            <rect width="32" height="32" rx="7" fill="#1B3C2D"/>
            <path d="M7 23V13l9-5.5 9 5.5v10H7z" fill="#2A7D5B"/>
            <rect x="12.5" y="16.5" width="7" height="6.5" rx="1" fill="#F7F3EE"/>
          </svg>
          <span>MyMortgageExpert</span>
        </div>
        <div class="dash-header__right">
          <div class="dash-user-menu">
            <button class="dash-user-menu__toggle" id="userMenuToggle">
              <span id="dashUser"></span>
              <svg width="10" height="6" viewBox="0 0 10 6" fill="none"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="dash-user-menu__dropdown" id="userMenuDropdown">
              <a href="#" id="changePasswordLink">Change Password</a>
              <a href="#" id="logoutBtn">Sign Out</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="dash-body">
      <button class="dash-hamburger" id="tabHamburger">
        <span id="tabHamburgerLabel">Calculator Rates</span>
        <svg width="12" height="7" viewBox="0 0 12 7" fill="none"><path d="M1 1l5 5 5-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="dash-tabs">
        <button class="dash-tab active" data-panel="rates">Calculator Rates</button>
        <button class="dash-tab" data-panel="homepage">Homepage Rates</button>
        <button class="dash-tab" data-panel="broker">Broker Info</button>
        <button class="dash-tab" data-panel="lenders">Lenders</button>
      </div>

      <!-- ===== CALCULATOR RATES ===== -->
      <div class="dash-panel active" id="panel-rates">

        <!-- Refinance -->
        <div class="dash-card">
          <div class="dash-card__title">Refinance Calculator <span class="dash-status" id="refinanceStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">Rates shown in the Refinance Calculator (fixed/variable toggle by term).</p>
          <table class="dash-table">
            <thead><tr><th>Term</th><th>Fixed Rate (%)</th><th>Variable Rate (%)</th><th></th></tr></thead>
            <tbody id="refinanceTableBody"></tbody>
          </table>
          <div class="add-row" style="margin-top:12px;">
            <select id="refinanceNewTerm" style="max-width:100px; padding:8px 12px; border:1.5px solid #d9ddd8; border-radius:8px; font-family:inherit;">
              <option value="">Term</option>
              <option value="1">1-Year</option><option value="2">2-Year</option><option value="3">3-Year</option>
              <option value="5">5-Year</option><option value="6">6-Year</option>
              <option value="7">7-Year</option><option value="8">8-Year</option><option value="9">9-Year</option><option value="10">10-Year</option>
            </select>
            <input type="number" step="0.01" placeholder="Fixed %" id="refinanceNewFixed" style="max-width:100px;">
            <input type="number" step="0.01" placeholder="Variable %" id="refinanceNewVariable" style="max-width:100px;">
            <button class="dash-btn dash-btn--outline" onclick="addTermRate('refinance')">Add Term</button>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" onclick="saveCalcRates('refinance')">Save</button>
          </div>
        </div>

        <!-- Renewal -->
        <div class="dash-card">
          <div class="dash-card__title">Renewal Calculator <span class="dash-status" id="renewalStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">Rates shown in the Renewal Calculator (fixed/variable toggle by term).</p>
          <table class="dash-table">
            <thead><tr><th>Term</th><th>Fixed Rate (%)</th><th>Variable Rate (%)</th><th></th></tr></thead>
            <tbody id="renewalTableBody"></tbody>
          </table>
          <div class="add-row" style="margin-top:12px;">
            <select id="renewalNewTerm" style="max-width:100px; padding:8px 12px; border:1.5px solid #d9ddd8; border-radius:8px; font-family:inherit;">
              <option value="">Term</option>
              <option value="1">1-Year</option><option value="2">2-Year</option><option value="3">3-Year</option>
              <option value="5">5-Year</option><option value="6">6-Year</option>
              <option value="7">7-Year</option><option value="8">8-Year</option><option value="9">9-Year</option><option value="10">10-Year</option>
            </select>
            <input type="number" step="0.01" placeholder="Fixed %" id="renewalNewFixed" style="max-width:100px;">
            <input type="number" step="0.01" placeholder="Variable %" id="renewalNewVariable" style="max-width:100px;">
            <button class="dash-btn dash-btn--outline" onclick="addTermRate('renewal')">Add Term</button>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" onclick="saveCalcRates('renewal')">Save</button>
          </div>
        </div>

        <!-- HELOC -->
        <div class="dash-card">
          <div class="dash-card__title">HELOC Calculator <span class="dash-status" id="helocStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">Interest-only rate used for HELOC payment calculations.</p>
          <div class="dash-form">
            <div style="max-width:200px;">
              <label>HELOC Rate (%)</label>
              <input type="number" step="0.01" id="helocRateInput">
            </div>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" onclick="saveSingleRate('heloc')">Save</button>
          </div>
        </div>

        <!-- Self-Employed -->
        <div class="dash-card">
          <div class="dash-card__title">Self-Employed Calculator <span class="dash-status" id="self-employedStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">Rates for the Refinance &amp; Debt Consolidation modes (fixed/variable by term), plus the HELOC mode rate.</p>
          <table class="dash-table">
            <thead><tr><th>Term</th><th>Fixed Rate (%)</th><th>Variable Rate (%)</th><th></th></tr></thead>
            <tbody id="self-employedTableBody"></tbody>
          </table>
          <div class="add-row" style="margin-top:12px;">
            <select id="self-employedNewTerm" style="max-width:100px; padding:8px 12px; border:1.5px solid #d9ddd8; border-radius:8px; font-family:inherit;">
              <option value="">Term</option>
              <option value="1">1-Year</option><option value="2">2-Year</option><option value="3">3-Year</option>
              <option value="5">5-Year</option><option value="6">6-Year</option>
              <option value="7">7-Year</option><option value="8">8-Year</option><option value="9">9-Year</option><option value="10">10-Year</option>
            </select>
            <input type="number" step="0.01" placeholder="Fixed %" id="self-employedNewFixed" style="max-width:100px;">
            <input type="number" step="0.01" placeholder="Variable %" id="self-employedNewVariable" style="max-width:100px;">
            <button class="dash-btn dash-btn--outline" onclick="addTermRate('self-employed')">Add Term</button>
          </div>
          <div class="dash-form" style="margin-top:16px;">
            <div style="max-width:200px;">
              <label>HELOC Mode Rate (%)</label>
              <input type="number" step="0.01" id="selfEmployedHelocRateInput">
            </div>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" onclick="saveSelfEmployedRates()">Save</button>
          </div>
        </div>

        <!-- Home Equity Loan -->
        <div class="dash-card">
          <div class="dash-card__title">Home Equity Loan Calculator <span class="dash-status" id="home-equity-loanStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">Default interest rate shown in the Home Equity Loan Calculator.</p>
          <div class="dash-form">
            <div style="max-width:200px;">
              <label>Default Rate (%)</label>
              <input type="number" step="0.01" id="homeEquityRateInput">
            </div>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" onclick="saveSingleRate('home-equity-loan')">Save</button>
          </div>
        </div>

      </div>

      <!-- ===== HOMEPAGE RATES ===== -->
      <div class="dash-panel" id="panel-homepage">
        <div class="dash-card">
          <div class="dash-card__title">Homepage Rate Cards <span class="dash-status" id="homepageStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">These are the 4 rate cards displayed in the "Today's Lowest Rates" section on the homepage.</p>
          <div id="homepageRatesList">
            <!-- Populated by JS -->
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" id="saveHomepageBtn">Save Homepage Rates</button>
          </div>
        </div>
      </div>

      <!-- ===== BROKER INFO ===== -->
      <div class="dash-panel" id="panel-broker">
        <div class="dash-card">
          <div class="dash-card__title">Brokers <span class="dash-status" id="brokerStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">The active broker is shown after a user submits the Get Pre-Approved or Help forms. Only one broker can be active at a time.</p>
          <div id="brokerList">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- Add New Broker -->
        <div class="dash-card">
          <div class="dash-card__title">Add New Broker</div>
          <div class="dash-form">
            <div class="dash-form__row">
              <div>
                <label>Broker Name</label>
                <input type="text" id="newBrokerName" placeholder="e.g. Lighthouse Lending">
              </div>
              <div>
                <label>Licence</label>
                <input type="text" id="newBrokerLicence" placeholder="e.g. FSRA# 13301">
              </div>
            </div>
            <div class="dash-form__row">
              <div>
                <label>Phone Display</label>
                <input type="text" id="newBrokerPhone" placeholder="e.g. 905-234-3323">
              </div>
              <div>
                <label>Phone Tel (digits only)</label>
                <input type="text" id="newBrokerPhoneTel" placeholder="e.g. 19052343323">
              </div>
            </div>
            <div>
              <label>Logo Filename</label>
              <input type="text" id="newBrokerLogo" placeholder="e.g. broker-logo.png">
            </div>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" id="addBrokerBtn">Add Broker</button>
          </div>
        </div>
      </div>

      <!-- ===== LENDERS ===== -->
      <div class="dash-panel" id="panel-lenders">
        <div class="dash-card">
          <div class="dash-card__title">Lender Network <span class="dash-status" id="lendersStatus"></span></div>
          <p style="color:#6b7c74; font-size:0.85rem; margin-bottom:20px;">These lenders are displayed on the homepage "Access to 30+ Lenders" section.</p>
          <div id="lendersList">
            <!-- Populated by JS -->
          </div>
          <div class="add-row">
            <input type="text" id="newLenderName" placeholder="Add new lender...">
            <button class="dash-btn dash-btn--outline" id="addLenderBtn">Add</button>
          </div>
          <div class="dash-actions">
            <button class="dash-btn dash-btn--primary" id="saveLendersBtn">Save Lenders</button>
          </div>
        </div>
      </div>

      <!-- ===== ACCOUNT ===== -->
      <div class="dash-panel" id="panel-account">
        <div class="dash-card">
          <a href="#" class="dash-card__back" id="accountBack">&larr; Back to dashboard</a>
          <div class="dash-card__title">Account Settings</div>
          <p class="dash-card__subtitle">Manage your admin account.</p>

          <h4 style="font-size:0.95rem; margin-bottom:16px;">Change Password</h4>
          <div class="password-success" id="passwordSuccess">Password updated successfully!</div>
          <div class="password-error" id="passwordError"></div>
          <div class="dash-form" id="changePasswordForm">
            <div>
              <label>New Password</label>
              <input type="password" id="newPassword" placeholder="Enter new password" minlength="6">
            </div>
            <div>
              <label>Confirm New Password</label>
              <input type="password" id="confirmPassword" placeholder="Confirm new password" minlength="6">
            </div>
            <div class="dash-actions" style="margin-top:8px;">
              <button class="dash-btn dash-btn--primary" id="changePasswordBtn">Update Password</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // =============================================
    // Supabase Init
    // =============================================
    const SUPABASE_URL = 'https://qsynstslucmrzwskhxty.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzeW5zdHNsdWNtcnp3c2toeHR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDYxNzIsImV4cCI6MjA4NzYyMjE3Mn0.nL9oQr3HBhcMhCM3uh6dVEsWFpn0795IrybosXIu1Es';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =============================================
    // Helpers
    // =============================================
    function flashStatus(el, text) {
      el.textContent = text || 'Saved!';
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2500);
    }

    // =============================================
    // Auth
    // =============================================
    const loginScreen = document.getElementById('loginScreen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');

    async function checkSession() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) {
        showDashboard(session.user);
      }
    }
    checkSession();

    // =============================================
    // Password Reset
    // =============================================
    const resetScreen = document.getElementById('resetScreen');
    const resetForm = document.getElementById('resetForm');
    const resetError = document.getElementById('resetError');
    const resetSuccess = document.getElementById('resetSuccess');

    document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.style.display = 'none';
      document.getElementById('forgotPasswordLink').parentElement.style.display = 'none';
      resetScreen.style.display = '';
      loginError.classList.remove('active');
    });

    document.getElementById('backToLogin').addEventListener('click', (e) => {
      e.preventDefault();
      resetScreen.style.display = 'none';
      loginForm.style.display = '';
      document.getElementById('forgotPasswordLink').parentElement.style.display = '';
      resetError.classList.remove('active');
      resetSuccess.style.display = 'none';
    });

    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      resetError.classList.remove('active');
      resetSuccess.style.display = 'none';
      const email = document.getElementById('resetEmail').value;
      document.getElementById('resetBtn').textContent = 'Sending...';

      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/admin.html'
      });

      document.getElementById('resetBtn').textContent = 'Send Reset Link';
      if (error) {
        resetError.textContent = error.message;
        resetError.classList.add('active');
        return;
      }
      resetSuccess.textContent = 'Reset link sent! Check your email.';
      resetSuccess.style.display = 'block';
    });

    // Handle password reset token from email link
    (async function() {
      const hash = window.location.hash;
      if (hash && hash.includes('type=recovery')) {
        const newPassword = prompt('Enter your new password:');
        if (newPassword) {
          const { error } = await sb.auth.updateUser({ password: newPassword });
          if (error) {
            alert('Error resetting password: ' + error.message);
          } else {
            alert('Password updated successfully! You can now sign in.');
            window.location.hash = '';
          }
        }
      }
    })();

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.remove('active');
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      document.getElementById('loginBtn').textContent = 'Signing in...';

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        loginError.textContent = error.message;
        loginError.classList.add('active');
        document.getElementById('loginBtn').textContent = 'Sign In';
        return;
      }
      showDashboard(data.user);
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await sb.auth.signOut();
      dashboard.classList.remove('active');
      loginScreen.classList.remove('hidden');
      document.getElementById('loginBtn').textContent = 'Sign In';
    });

    function showDashboard(user) {
      loginScreen.classList.add('hidden');
      dashboard.classList.add('active');
      document.getElementById('dashUser').textContent = user.email;
      loadRates();
      loadBroker();
      loadLenders();
      loadHomepageRates();
    }

    // =============================================
    // Tabs
    // =============================================
    const tabHamburger = document.getElementById('tabHamburger');
    const tabHamburgerLabel = document.getElementById('tabHamburgerLabel');
    const dashTabs = document.querySelector('.dash-tabs');

    tabHamburger.addEventListener('click', () => {
      tabHamburger.classList.toggle('open');
      dashTabs.classList.toggle('open');
    });

    document.querySelectorAll('.dash-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.dash-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
        // Update hamburger label and close menu on mobile
        tabHamburgerLabel.textContent = tab.textContent;
        tabHamburger.classList.remove('open');
        dashTabs.classList.remove('open');
      });
    });

    // =============================================
    // User Menu Dropdown
    // =============================================
    const userMenuToggle = document.getElementById('userMenuToggle');
    const userMenuDropdown = document.getElementById('userMenuDropdown');

    userMenuToggle.addEventListener('click', () => {
      userMenuDropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (!tabHamburger.contains(e.target) && !dashTabs.contains(e.target)) {
        tabHamburger.classList.remove('open');
        dashTabs.classList.remove('open');
      }
      if (!userMenuToggle.contains(e.target) && !userMenuDropdown.contains(e.target)) {
        userMenuDropdown.classList.remove('active');
      }
    });

    // Navigate to account panel
    document.getElementById('changePasswordLink').addEventListener('click', (e) => {
      e.preventDefault();
      userMenuDropdown.classList.remove('active');
      document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.dash-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('panel-account').classList.add('active');
    });

    // Back to dashboard from account
    document.getElementById('accountBack').addEventListener('click', (e) => {
      e.preventDefault();
      document.querySelectorAll('.dash-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('panel-rates').classList.add('active');
      document.querySelector('.dash-tab[data-panel="rates"]').classList.add('active');
    });

    // Change password
    document.getElementById('changePasswordBtn').addEventListener('click', async () => {
      const newPw = document.getElementById('newPassword').value;
      const confirmPw = document.getElementById('confirmPassword').value;
      const successEl = document.getElementById('passwordSuccess');
      const errorEl = document.getElementById('passwordError');
      successEl.style.display = 'none';
      errorEl.style.display = 'none';

      if (!newPw || newPw.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters.';
        errorEl.style.display = 'block';
        return;
      }
      if (newPw !== confirmPw) {
        errorEl.textContent = 'Passwords do not match.';
        errorEl.style.display = 'block';
        return;
      }

      const { error } = await sb.auth.updateUser({ password: newPw });
      if (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        return;
      }
      successEl.style.display = 'block';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    });

    // =============================================
    // CALCULATOR RATES (per-calculator)
    // =============================================
    let allRatesData = [];

    async function loadRates() {
      const { data, error } = await sb.from('rates').select('*').order('term_years');
      if (error) { console.error(error); return; }
      allRatesData = data;
      renderCalcRates('refinance');
      renderCalcRates('renewal');
      renderCalcRates('self-employed');
      renderSingleRate('heloc', 'helocRateInput');
      renderSingleRate('self-employed-heloc', 'selfEmployedHelocRateInput');
      renderSingleRate('home-equity-loan', 'homeEquityRateInput');
    }

    function renderCalcRates(calc) {
      const tbody = document.getElementById(calc + 'TableBody');
      const rows = allRatesData.filter(r => r.calculator === calc && r.term_years);
      tbody.innerHTML = rows.map(r => `
        <tr data-id="${r.id}">
          <td><strong>${r.term_years}-Year</strong></td>
          <td><input type="number" step="0.01" value="${r.fixed_rate}"></td>
          <td><input type="number" step="0.01" value="${r.variable_rate}"></td>
          <td><button class="dash-btn dash-btn--danger dash-btn--sm" onclick="removeTermRate('${r.id}', '${calc}')">Remove</button></td>
        </tr>
      `).join('');
    }

    function renderSingleRate(calc, inputId) {
      const row = allRatesData.find(r => r.calculator === calc);
      if (row) {
        document.getElementById(inputId).value = row.rate;
        document.getElementById(inputId).dataset.id = row.id;
      }
    }

    // Add a new term row
    window.addTermRate = async function(calc) {
      const termSel = document.getElementById(calc + 'NewTerm');
      const fixedIn = document.getElementById(calc + 'NewFixed');
      const varIn = document.getElementById(calc + 'NewVariable');
      const term = parseInt(termSel.value);
      const fixed = parseFloat(fixedIn.value);
      const variable = parseFloat(varIn.value);

      if (!term || isNaN(fixed) || isNaN(variable)) {
        alert('Please fill in term, fixed rate, and variable rate.');
        return;
      }

      // Check for duplicate term
      const exists = allRatesData.find(r => r.calculator === calc && r.term_years === term);
      if (exists) {
        alert(term + '-Year term already exists for this calculator. Edit the existing row instead.');
        return;
      }

      const { error } = await sb.from('rates').insert({
        calculator: calc,
        term_years: term,
        fixed_rate: fixed,
        variable_rate: variable
      });
      if (error) { alert('Error adding term: ' + error.message); return; }

      termSel.value = '';
      fixedIn.value = '';
      varIn.value = '';
      await loadRates();
      flashStatus(document.getElementById(calc + 'Status'), 'Added!');
    };

    // Remove a term row
    window.removeTermRate = async function(id, calc) {
      if (!confirm('Remove this term?')) return;
      const { error } = await sb.from('rates').delete().eq('id', id);
      if (error) { alert('Error removing: ' + error.message); return; }
      await loadRates();
      flashStatus(document.getElementById(calc + 'Status'), 'Removed!');
    };

    // Save term-based rates (refinance, renewal, self-employed)
    window.saveCalcRates = async function(calc) {
      const tbody = document.getElementById(calc + 'TableBody');
      const rows = tbody.querySelectorAll('tr');
      for (const row of rows) {
        const id = row.dataset.id;
        const inputs = row.querySelectorAll('input');
        const { error } = await sb.from('rates').update({
          fixed_rate: parseFloat(inputs[0].value),
          variable_rate: parseFloat(inputs[1].value),
          updated_at: new Date().toISOString()
        }).eq('id', id);
        if (error) { alert('Error saving: ' + error.message); return; }
      }
      flashStatus(document.getElementById(calc + 'Status'));
    };

    // Save single rate (heloc, home-equity-loan)
    window.saveSingleRate = async function(calc) {
      const inputId = calc === 'heloc' ? 'helocRateInput' : 'homeEquityRateInput';
      const input = document.getElementById(inputId);
      const { error } = await sb.from('rates').update({
        rate: parseFloat(input.value),
        updated_at: new Date().toISOString()
      }).eq('id', input.dataset.id);
      if (error) { alert('Error saving: ' + error.message); return; }
      flashStatus(document.getElementById(calc + 'Status'));
    };

    // Save self-employed (term rates + heloc rate)
    window.saveSelfEmployedRates = async function() {
      await saveCalcRates('self-employed');
      const input = document.getElementById('selfEmployedHelocRateInput');
      const { error } = await sb.from('rates').update({
        rate: parseFloat(input.value),
        updated_at: new Date().toISOString()
      }).eq('id', input.dataset.id);
      if (error) { alert('Error saving: ' + error.message); return; }
      flashStatus(document.getElementById('self-employedStatus'));
    };

    // =============================================
    // HOMEPAGE RATES
    // =============================================
    let homepageRatesData = [];

    async function loadHomepageRates() {
      const { data, error } = await sb.from('homepage_rates').select('*').order('display_order');
      if (error) { console.error(error); return; }
      homepageRatesData = data;
      renderHomepageRates();
    }

    function renderHomepageRates() {
      const list = document.getElementById('homepageRatesList');
      list.innerHTML = homepageRatesData.map((r, i) => `
        <div class="homepage-rate-row" data-id="${r.id}">
          <input type="text" value="${r.badge_text}" data-field="badge_text" placeholder="e.g. 5-Year Fixed">
          <input type="number" step="0.01" value="${r.rate_value}" data-field="rate_value" placeholder="4.04">
          <input type="text" value="${r.meta_text}" data-field="meta_text" placeholder="as low as · Insured rate">
        </div>
      `).join('');
    }

    document.getElementById('saveHomepageBtn').addEventListener('click', async () => {
      const rows = document.querySelectorAll('.homepage-rate-row');
      for (const row of rows) {
        const id = row.dataset.id;
        const badge_text = row.querySelector('[data-field="badge_text"]').value;
        const rate_value = parseFloat(row.querySelector('[data-field="rate_value"]').value);
        const meta_text = row.querySelector('[data-field="meta_text"]').value;
        const { error } = await sb.from('homepage_rates').update({
          badge_text, rate_value, meta_text, updated_at: new Date().toISOString()
        }).eq('id', id);
        if (error) { alert('Error: ' + error.message); return; }
      }
      flashStatus(document.getElementById('homepageStatus'));
    });

    // =============================================
    // BROKERS
    // =============================================
    let brokersData = [];

    async function loadBroker() {
      const { data, error } = await sb.from('broker').select('*').order('is_active', { ascending: false }).order('updated_at', { ascending: false });
      if (error) { console.error(error); return; }
      brokersData = data;
      renderBrokers();
    }

    function renderBrokers() {
      const list = document.getElementById('brokerList');
      if (!brokersData.length) {
        list.innerHTML = '<p style="color:#6b7c74; font-size:0.9rem;">No brokers added yet.</p>';
        return;
      }
      list.innerHTML = brokersData.map(b => `
        <div class="broker-card ${b.is_active ? 'broker-card--active' : ''}">
          <span class="broker-card__badge ${b.is_active ? 'broker-card__badge--active' : 'broker-card__badge--inactive'}">${b.is_active ? 'Active' : 'Inactive'}</span>
          <div class="broker-card__name">${b.name}</div>
          <div class="broker-card__detail">Phone: ${b.phone_display}</div>
          <div class="broker-card__detail">Licence: ${b.licence}</div>
          <div class="broker-card__detail">Logo: ${b.logo_url || '—'}</div>
          <div class="broker-card__actions">
            <button class="dash-btn dash-btn--outline dash-btn--sm" onclick="editBroker('${b.id}')">Edit</button>
            ${b.is_active
              ? '<button class="dash-btn dash-btn--outline dash-btn--sm" onclick="toggleBrokerActive(\''+b.id+'\', false)">Deactivate</button>'
              : '<button class="dash-btn dash-btn--primary dash-btn--sm" onclick="toggleBrokerActive(\''+b.id+'\', true)">Set Active</button>'}
            <button class="dash-btn dash-btn--danger dash-btn--sm" onclick="deleteBroker('${b.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Set a broker as active (deactivates all others)
    window.toggleBrokerActive = async function(id, activate) {
      if (activate) {
        // Deactivate all first
        const { error: deactErr } = await sb.from('broker').update({ is_active: false, updated_at: new Date().toISOString() }).neq('id', '00000000-0000-0000-0000-000000000000');
        if (deactErr) { alert('Error: ' + deactErr.message); return; }
      }
      const { error } = await sb.from('broker').update({ is_active: activate, updated_at: new Date().toISOString() }).eq('id', id);
      if (error) { alert('Error: ' + error.message); return; }
      await loadBroker();
      flashStatus(document.getElementById('brokerStatus'), activate ? 'Activated!' : 'Deactivated!');
    };

    // Delete a broker
    window.deleteBroker = async function(id) {
      if (!confirm('Delete this broker?')) return;
      const { error } = await sb.from('broker').delete().eq('id', id);
      if (error) { alert('Error: ' + error.message); return; }
      await loadBroker();
      flashStatus(document.getElementById('brokerStatus'), 'Deleted!');
    };

    // Edit a broker — swap card to inline form
    window.editBroker = function(id) {
      const b = brokersData.find(x => x.id === id);
      if (!b) return;
      const list = document.getElementById('brokerList');
      const card = list.querySelector('.broker-card--editing');
      if (card) { loadBroker(); return; } // close any open edit

      // Find the card and replace with edit form
      const cards = list.querySelectorAll('.broker-card');
      const idx = brokersData.findIndex(x => x.id === id);
      if (idx < 0 || !cards[idx]) return;

      cards[idx].classList.add('broker-card--editing');
      cards[idx].innerHTML = `
        <div class="dash-form">
          <div class="dash-form__row">
            <div><label>Broker Name</label><input type="text" id="editBrokerName" value="${b.name}"></div>
            <div><label>Licence</label><input type="text" id="editBrokerLicence" value="${b.licence}"></div>
          </div>
          <div class="dash-form__row">
            <div><label>Phone Display</label><input type="text" id="editBrokerPhone" value="${b.phone_display}"></div>
            <div><label>Phone Tel</label><input type="text" id="editBrokerPhoneTel" value="${b.phone_tel}"></div>
          </div>
          <div><label>Logo Filename</label><input type="text" id="editBrokerLogo" value="${b.logo_url || ''}"></div>
          <div class="dash-actions" style="margin-top:12px;">
            <button class="dash-btn dash-btn--primary dash-btn--sm" onclick="saveBrokerEdit('${b.id}')">Save</button>
            <button class="dash-btn dash-btn--outline dash-btn--sm" onclick="loadBroker()">Cancel</button>
          </div>
        </div>
      `;
    };

    window.saveBrokerEdit = async function(id) {
      const { error } = await sb.from('broker').update({
        name: document.getElementById('editBrokerName').value,
        licence: document.getElementById('editBrokerLicence').value,
        phone_display: document.getElementById('editBrokerPhone').value,
        phone_tel: document.getElementById('editBrokerPhoneTel').value,
        logo_url: document.getElementById('editBrokerLogo').value,
        updated_at: new Date().toISOString()
      }).eq('id', id);
      if (error) { alert('Error: ' + error.message); return; }
      await loadBroker();
      flashStatus(document.getElementById('brokerStatus'));
    };

    // Add new broker
    document.getElementById('addBrokerBtn').addEventListener('click', async () => {
      const name = document.getElementById('newBrokerName').value.trim();
      const licence = document.getElementById('newBrokerLicence').value.trim();
      const phone = document.getElementById('newBrokerPhone').value.trim();
      const phoneTel = document.getElementById('newBrokerPhoneTel').value.trim();
      const logo = document.getElementById('newBrokerLogo').value.trim();

      if (!name || !phone) {
        alert('Please fill in at least the broker name and phone number.');
        return;
      }

      const { error } = await sb.from('broker').insert({
        name, licence, phone_display: phone, phone_tel: phoneTel, logo_url: logo, is_active: false
      });
      if (error) { alert('Error: ' + error.message); return; }

      // Clear form
      document.getElementById('newBrokerName').value = '';
      document.getElementById('newBrokerLicence').value = '';
      document.getElementById('newBrokerPhone').value = '';
      document.getElementById('newBrokerPhoneTel').value = '';
      document.getElementById('newBrokerLogo').value = '';

      await loadBroker();
      flashStatus(document.getElementById('brokerStatus'), 'Added!');
    });

    // =============================================
    // LENDERS
    // =============================================
    let lendersData = [];

    async function loadLenders() {
      const { data, error } = await sb.from('lenders').select('*').order('display_order');
      if (error) { console.error(error); return; }
      lendersData = data;
      renderLenders();
    }

    function renderLenders() {
      const list = document.getElementById('lendersList');
      list.innerHTML = lendersData.map((l, i) => `
        <div class="lender-row" data-id="${l.id}">
          <span class="lender-row__order">${i + 1}.</span>
          <input type="text" value="${l.name}" data-field="name">
          <button class="dash-btn dash-btn--danger dash-btn--sm" onclick="removeLender('${l.id}')">Remove</button>
        </div>
      `).join('');
    }

    window.removeLender = function(id) {
      lendersData = lendersData.filter(l => l.id !== id);
      renderLenders();
    };

    document.getElementById('addLenderBtn').addEventListener('click', () => {
      const nameInput = document.getElementById('newLenderName');
      const name = nameInput.value.trim();
      if (!name) return;
      lendersData.push({ id: 'new-' + Date.now(), name, display_order: lendersData.length + 1, is_active: true });
      renderLenders();
      nameInput.value = '';
    });

    document.getElementById('saveLendersBtn').addEventListener('click', async () => {
      // Delete all existing, then re-insert with updated order and names
      const { error: delError } = await sb.from('lenders').delete().neq('id', '00000000-0000-0000-0000-000000000000');
      if (delError) { alert('Error clearing lenders: ' + delError.message); return; }

      const rows = document.querySelectorAll('.lender-row');
      const inserts = [];
      rows.forEach((row, i) => {
        const name = row.querySelector('input[data-field="name"]').value.trim();
        if (name) {
          inserts.push({ name, display_order: i + 1, is_active: true });
        }
      });

      if (inserts.length > 0) {
        const { error } = await sb.from('lenders').insert(inserts);
        if (error) { alert('Error saving lenders: ' + error.message); return; }
      }
      loadLenders();
      flashStatus(document.getElementById('lendersStatus'));
    });
  </script>
</body>
</html>
