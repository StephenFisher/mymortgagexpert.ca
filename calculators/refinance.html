<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refinance Calculator — MyMortgageExpert</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@800&family=Playfair+Display:ital,wght@1,600;1,700&display=swap" rel="stylesheet">
</head>
<body>

  <!-- ======= NAV BAR ======= -->
  <header class="navbar" id="navbar">
    <div class="container navbar__inner">
      <a href="/" class="navbar__logo">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <rect width="32" height="32" rx="7" fill="#1B3C2D"/>
          <path d="M7 23V13l9-5.5 9 5.5v10H7z" fill="#2A7D5B"/>
          <rect x="12.5" y="16.5" width="7" height="6.5" rx="1" fill="#F7F3EE"/>
        </svg>
        <span>MyMortgageExpert</span>
      </a>
      <nav class="navbar__links" id="navLinks">
        <div class="navbar__dropdown">
          <button class="navbar__dropdown-toggle">Calculators <svg width="10" height="6" viewBox="0 0 10 6" fill="none"><path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
          <div class="navbar__dropdown-menu">
            <a href="/calculators/heloc.html">HELOC Calculator</a>
            <a href="/calculators/refinance.html">Refinance Calculator</a>
            <a href="/calculators/renewal.html">Renewal Calculator</a>
            <a href="/calculators/home-equity-loan.html">Home Equity Loan Calculator</a>
            <a href="/calculators/self-employed.html">Self-Employed Calculator</a>
            <a href="/calculators/land-transfer-tax.html">Land Transfer Tax Calculator</a>
            <a href="/calculators/purchase.html">Purchase Calculator</a>
            <a href="/calculators/affordability.html">Affordability Calculator</a>
          </div>
        </div>
        <a href="/mortgages.html">Mortgages</a>
        <a href="/how-it-works.html">How It Works</a>
        <a href="/about.html">About</a>
        <a href="tel:18445002535" class="navbar__mobile-phone">1-844-500-2535</a>
        <a href="#" class="btn btn--primary navbar__mobile-cta open-modal">Get Pre-Approved</a>
      </nav>
      <div class="navbar__right">
        <a href="tel:18445002535" class="navbar__phone">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M14.67 11.44l-2.18-.93a1 1 0 00-1.05.18l-1.2 1.07a10.5 10.5 0 01-4.9-4.9l1.07-1.2a1 1 0 00.18-1.05l-.93-2.18A1 1 0 004.6 1.5H2.5A1 1 0 001.5 2.6 13 13 0 0013.4 14.5a1 1 0 001.1-1h-2.1a1 1 0 00-1.06-.93z" stroke="#1B3C2D" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          1-844-500-2535
        </a>
        <a href="#" class="btn btn--primary navbar__cta open-modal">Get Pre-Approved</a>
      </div>
      <button class="navbar__hamburger" id="hamburger" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- ======= REFINANCE CALCULATOR ======= -->
  <section class="heloc">
    <div class="container">
      <div class="heloc__nav">
        <a href="/" class="heloc__back">&larr; Back to Home</a>
      </div>

      <div class="heloc__header">
        <span class="heloc__tag">CALCULATOR</span>
        <h1 class="heloc__title">Refinance Calculator</h1>
        <p class="heloc__subtitle">Thinking about refinancing? Compare your current payment to a new mortgage with a lower rate, extended amortization, or equity access — and see what you could save.</p>
      </div>

      <div class="heloc__layout">
        <!-- LEFT: Input Form -->
        <div class="heloc__form-card">
          <h3 class="heloc__form-title">Your Refinance Details</h3>
          <div class="heloc__form">
            <div class="form-group">
              <label for="refiHomeValue">Estimated Home Value</label>
              <input type="text" id="refiHomeValue" value="" placeholder="$950,000" inputmode="numeric">
              <span class="heloc__helper">Enter the current estimated value of your home</span>
            </div>
            <div class="form-group">
              <label for="refiBalance">Current Mortgage Balance</label>
              <input type="text" id="refiBalance" value="" placeholder="$450,000" inputmode="numeric">
              <span class="heloc__helper">Your remaining mortgage principal</span>
            </div>
            <div class="form-group">
              <label for="refiCurrentRate">Current Interest Rate (%)</label>
              <input type="text" id="refiCurrentRate" value="" placeholder="5.49" inputmode="decimal">
              <span class="heloc__helper">The rate you are currently paying</span>
            </div>
            <div class="form-group">
              <label for="refiCurrentAmort">Current Remaining Amortization</label>
              <select id="refiCurrentAmort">
                <option value="5">5 Years</option>
                <option value="10">10 Years</option>
                <option value="15">15 Years</option>
                <option value="20" selected>20 Years</option>
                <option value="25">25 Years</option>
                <option value="30">30 Years</option>
              </select>
              <span class="heloc__helper">Years left on your current mortgage</span>
              <span class="heloc__helper heloc__helper--result" id="refiCurrentPaymentDisplay">Estimated current monthly payment: --</span>
            </div>
            <div class="form-group" style="margin-top:8px;">
              <label>Would You Like to Access Equity?</label>
              <div class="heloc__toggle" id="refiEquityToggle">
                <button type="button" class="heloc__toggle-btn active" data-value="no">No</button>
                <button type="button" class="heloc__toggle-btn" data-value="yes">Yes</button>
              </div>
            </div>
            <div class="form-group" id="refiEquityField" style="display:none;">
              <label for="refiEquityAmount">How Much Would You Like to Access?</label>
              <input type="text" id="refiEquityAmount" value="" placeholder="$100,000" inputmode="numeric">
              <span class="heloc__helper">Amount of equity to add to your new mortgage</span>
            </div>
            <div class="form-group">
              <label for="refiNewAmort">New Amortization Period</label>
              <select id="refiNewAmort">
                <option value="5">5 Years</option>
                <option value="10">10 Years</option>
                <option value="15">15 Years</option>
                <option value="20">20 Years</option>
                <option value="25" selected>25 Years</option>
                <option value="30">30 Years</option>
              </select>
              <span class="heloc__helper">The amortization for your new refinanced mortgage</span>
            </div>
            <div class="form-group">
              <label for="refiTerm">New Term Length</label>
              <select id="refiTerm">
                <!-- Populated dynamically from Supabase -->
              </select>
              <span class="heloc__helper">The length of your new mortgage term</span>
            </div>
            <div class="form-group">
              <label>Would You Like</label>
              <div class="heloc__toggle" id="refiRateTypeToggle">
                <button type="button" class="heloc__toggle-btn active" data-value="fixed">Fixed</button>
                <button type="button" class="heloc__toggle-btn" data-value="variable">Variable</button>
              </div>
            </div>
            <div class="form-group">
              <label for="refiNewRate">New Refinance Rate (%)</label>
              <input type="text" id="refiNewRate" value="4.04" inputmode="decimal" readonly style="background:#f0f0f0; cursor:default;">
              <span class="heloc__helper">Rate based on selected term and type from our posted rates</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: Results Card -->
        <div class="heloc__results-card" id="refiResults">
          <div class="heloc__results-inner">
          <h3 class="heloc__results-title">Your Refinance Estimate</h3>

          <div class="renewal-savings-hero" id="refiSavingsHero">
            <span class="renewal-savings-hero__label">You Could Save</span>
            <span class="renewal-savings-hero__amount" id="resultTermSavings">$0</span>
            <span class="renewal-savings-hero__term" id="resultTermLabel">over your 5-year term</span>
          </div>

          <div class="heloc__result-row">
            <span class="heloc__result-label">Max Mortgage (80% LTV)</span>
            <span class="heloc__result-value" id="resultMaxMortgage">$0</span>
          </div>
          <div class="heloc__result-divider"></div>

          <div class="heloc__result-row">
            <span class="heloc__result-label">Available Equity</span>
            <span class="heloc__result-value" id="resultEquity">$0</span>
          </div>
          <div class="heloc__result-divider"></div>

          <!-- Equity row (hidden by default) -->
          <div id="refiNewMortgageRow" style="display:none;">
            <div class="heloc__result-row">
              <span class="heloc__result-label">New Mortgage Amount</span>
              <span class="heloc__result-value" id="resultNewMortgage">$0</span>
            </div>
            <div class="heloc__result-divider"></div>
          </div>

          <div class="heloc__result-row">
            <span class="heloc__result-label">Current Monthly Payment*</span>
            <span class="heloc__result-value heloc__result-value--warning" id="resultCurrentPayment">$0</span>
          </div>
          <div class="heloc__result-divider"></div>

          <div class="heloc__result-row">
            <span class="heloc__result-label">New Monthly Payment</span>
            <span class="heloc__result-value heloc__result-value--highlight" id="resultNewPayment">$0</span>
          </div>
          <div class="heloc__result-divider"></div>

          <div class="heloc__result-row">
            <span class="heloc__result-label">Monthly Savings</span>
            <span class="heloc__result-value heloc__result-value--savings" id="resultMonthlySavings">$0</span>
          </div>
          <div class="heloc__result-divider"></div>

          <div class="heloc__result-row">
            <span class="heloc__result-label">Annual Savings</span>
            <span class="heloc__result-value heloc__result-value--savings" id="resultAnnualSavings">$0</span>
          </div>

          <!-- Warning (hidden by default) -->
          <div class="heloc__warning" id="refiWarning" style="display:none;">
            Your requested equity exceeds your available equity. Please adjust your inputs.
          </div>

          <a href="#" class="btn btn--white btn--large heloc__results-cta open-modal">Speak to a Specialist</a>
          <p class="heloc__results-disclosure">* Current monthly payment is an estimate based on the information provided.<br>These numbers represent a non-binding estimate. Rates and terms subject to approval.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ======= EDUCATIONAL CONTENT ======= -->
  <section class="heloc-info">
    <div class="container heloc-info__container">
      <div class="heloc-info__body">
        <h2>What Is Mortgage Refinancing?</h2>
        <p>Mortgage refinancing means replacing your existing mortgage with a new one, typically to take advantage of better rates, access your home equity, or change your mortgage terms. When you refinance, your current mortgage is paid off and replaced with a new agreement.</p>

        <h2>Why Refinance Your Mortgage?</h2>
        <p>Homeowners refinance for a variety of reasons:</p>
        <ul>
          <li><strong>Lower your interest rate:</strong> If rates have dropped since you took out your mortgage, refinancing can reduce your monthly payment and total interest costs.</li>
          <li><strong>Access home equity:</strong> Cash-out refinancing lets you borrow against your home's value for renovations, investments, or other major expenses.</li>
          <li><strong>Consolidate debt:</strong> Roll high-interest debts into your mortgage at a much lower rate, simplifying payments and saving on interest.</li>
          <li><strong>Change your term:</strong> Switch from a variable to fixed rate for stability, or shorten your amortization to pay off your home faster.</li>
        </ul>

        <h2>How Much Can You Refinance?</h2>
        <p>In Canada, you can refinance up to 80% of your home's appraised value (loan-to-value ratio). This means if your home is worth $550,000, the maximum mortgage you can carry is $440,000. Any difference between that and your current balance is equity you can potentially access.</p>

        <h2>Costs to Consider</h2>
        <p>Refinancing isn't free. Before making the switch, factor in these potential costs:</p>
        <ul>
          <li><strong>Prepayment penalty:</strong> If you're breaking your mortgage mid-term, your lender may charge a penalty — typically 3 months' interest or the interest rate differential (IRD), whichever is higher.</li>
          <li><strong>Legal fees:</strong> A lawyer or notary is required to register the new mortgage, usually $800–$1,500.</li>
          <li><strong>Appraisal fee:</strong> Your lender may require a home appraisal, typically $300–$500.</li>
          <li><strong>Discharge fee:</strong> Your current lender may charge a fee to discharge your existing mortgage.</li>
        </ul>

        <div class="article__cta-box">
          <h3>Is refinancing right for you?</h3>
          <p>Speak with a licensed mortgage specialist to compare your options and find out how much you could save by refinancing. No obligation, no credit check required.</p>
          <a href="#" class="btn btn--primary btn--large open-modal">Speak to a Specialist</a>
        </div>
      </div>
    </div>
  </section>

  <!-- ======= FOOTER ======= -->
  <footer class="footer">
    <div class="container footer__inner">
      <div class="footer__top">
        <div class="footer__brand">
          <a href="/" class="navbar__logo">
            <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
              <rect width="32" height="32" rx="7" fill="#2A7D5B"/>
              <path d="M7 23V13l9-5.5 9 5.5v10H7z" fill="#1B3C2D"/>
              <rect x="12.5" y="16.5" width="7" height="6.5" rx="1" fill="#F7F3EE"/>
            </svg>
            <span>MyMortgageExpert</span>
          </a>
          <p class="footer__tagline">Helping Canadians find the best mortgage rates since 2019.</p>
        </div>
        <div class="footer__links">
          <div class="footer__col">
            <h4>About</h4>
            <a href="/about.html">Our Story</a>
            <a href="/how-it-works.html">How It Works</a>
            <a href="#" class="open-contact-modal">Contact</a>
          </div>
          <div class="footer__col">
            <h4>Resources</h4>
            <a href="/guides/first-time-home-buyer.html">First-Time Buyer Guide</a>
            <a href="/guides/refinancing-your-mortgage.html">Refinancing Guide</a>
            <a href="/guides/mortgage-renewal.html">Mortgage Renewal Guide</a>
          </div>
          <div class="footer__col">
            <h4>Calculators</h4>
            <a href="#">Payment Calculator</a>
            <a href="#">Affordability</a>
            <a href="#">Land Transfer Tax</a>
            <a href="#">CMHC Insurance</a>
          </div>
          <div class="footer__col">
            <h4>Legal</h4>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
            <a href="#">Accessibility</a>
            <a href="#">Disclaimer</a>
          </div>
        </div>
      </div>
      <div class="footer__bottom">
        <p>&copy; 2026 MyMortgageExpert. All rights reserved.</p>
        <div class="footer__legal">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- ======= SPECIALIST MODAL ======= -->
  <div class="modal-overlay" id="preApprovalModal">
    <div class="modal" id="preApprovalModalInner">
      <button class="modal__close" id="modalClose" aria-label="Close">&times;</button>
      <h2 class="modal__title">Speak to a Specialist</h2>
      <p class="modal__subtitle">Enter your details and we'll connect you with a licensed mortgage broker.</p>
      <form class="modal__form" id="specialistForm">
        <div class="form-group">
          <label for="specName">Name</label>
          <input type="text" id="specName" placeholder="Your Name" required>
        </div>
        <div class="form-group">
          <label for="specPhone">Phone Number</label>
          <input type="tel" id="specPhone" placeholder="(555) 555-5555" required>
        </div>
        <div class="form-group">
          <label for="specEmail">Email</label>
          <input type="email" id="specEmail" placeholder="you@example.com" required>
        </div>
        <p class="modal__disclosure" style="margin-bottom:12px;">By clicking below you consent to being contacted by a licensed broker.</p>
        <button type="submit" class="btn btn--primary btn--large modal__submit">Connect Me With My Broker</button>
      </form>
    </div>
  </div>

  <!-- ======= CONTACT MODAL ======= -->
  <div class="modal-overlay" id="contactModal">
    <div class="modal">
      <button class="modal__close" id="contactModalClose" aria-label="Close">&times;</button>
      <h2 class="modal__title">Contact Us</h2>
      <p class="modal__subtitle">Have a question? Send us a message and we'll get back to you.</p>
      <form class="modal__form" id="contactForm">
        <div class="form-group">
          <label for="contactName">Name</label>
          <input type="text" id="contactName" placeholder="Your Name" required>
        </div>
        <div class="form-group">
          <label for="contactPhone">Phone Number</label>
          <input type="tel" id="contactPhone" placeholder="(555) 555-5555" required>
        </div>
        <div class="form-group">
          <label for="contactEmail">Email</label>
          <input type="email" id="contactEmail" placeholder="you@example.com" required>
        </div>
        <div class="form-group">
          <label for="contactComments">Comments</label>
          <textarea id="contactComments" rows="4" placeholder="How can we help?" required style="width:100%; padding:12px 14px; border:1.5px solid var(--border); border-radius:var(--radius-md); font-family:inherit; font-size:0.92rem; resize:vertical;"></textarea>
        </div>
        <p class="modal__disclosure" style="margin-bottom:16px;">By sending this message you consent to MyMortgageExpert collecting your personal information to respond to your inquiry. We will not share your information with third parties.</p>
        <button type="submit" class="btn btn--primary btn--large modal__submit">Send Message</button>
      </form>
    </div>
  </div>

  <script>
    // ===========================
    // Mobile Menu
    // ===========================
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.getElementById('navLinks');
    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navLinks.classList.toggle('active');
    });
    navLinks.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        hamburger.classList.remove('active');
        navLinks.classList.remove('active');
      });
    });

    // ===========================
    // Pre-Approval Modal
    // ===========================
    const modal = document.getElementById('preApprovalModal');
    const modalClose = document.getElementById('modalClose');
    document.querySelectorAll('.open-modal').forEach(btn => {
      btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        return false;
      };
    });

    modalClose.addEventListener('click', () => {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (modal.classList.contains('active')) { modal.classList.remove('active'); document.body.style.overflow = ''; }
        if (contactModal.classList.contains('active')) { contactModal.classList.remove('active'); document.body.style.overflow = ''; }
      }
    });

    // Contact modal
    var contactModal = document.getElementById('contactModal');
    var contactModalClose = document.getElementById('contactModalClose');
    document.querySelectorAll('.open-contact-modal').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        contactModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    });
    contactModalClose.addEventListener('click', function() { contactModal.classList.remove('active'); document.body.style.overflow = ''; });
    contactModal.addEventListener('click', function(e) { if (e.target === contactModal) { contactModal.classList.remove('active'); document.body.style.overflow = ''; } });
    document.getElementById('contactForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var cName = document.getElementById('contactName').value;
      var cPhone = document.getElementById('contactPhone').value;
      var cEmail = document.getElementById('contactEmail').value;
      var cComments = document.getElementById('contactComments').value;
      (async function() { await submitLead({ first_name: cName, last_name: '', email: cEmail, phone: cPhone, source: 'contact', page: window.location.pathname, notes: cComments }); })();
      e.target.closest('.modal').innerHTML = '<button class="modal__close" id="contactModalCloseSuccess" aria-label="Close">&times;</button><div style="text-align:center; padding:40px 20px;"><h2 class="modal__title">Message Sent</h2><p class="modal__subtitle">Thanks, ' + cName + '. We\'ll be in touch shortly.</p></div>';
      document.getElementById('contactModalCloseSuccess').addEventListener('click', function() { contactModal.classList.remove('active'); document.body.style.overflow = ''; });
    });

    var broker = {
      name: 'Lighthouse Lending',
      phone: '905-234-3323',
      phoneTel: '19052343323',
      licence: 'FSRA# 13301',
      logo: '../lighthouse-lending-logo.png'
    };

    function getCalculatorData() {
      return {
        type: 'refinance',
        inputs: {
          homeValue: document.getElementById('refiHomeValue').value,
          currentBalance: document.getElementById('refiBalance').value,
          currentRate: document.getElementById('refiCurrentRate').value + '%',
          currentAmortization: document.getElementById('refiCurrentAmort').value + ' years',
          accessEquity: document.querySelector('#refiEquityToggle .heloc__toggle-btn.active') ? document.querySelector('#refiEquityToggle .heloc__toggle-btn.active').textContent : 'No',
          equityAmount: document.getElementById('refiEquityAmount').value || 'N/A',
          newAmortization: document.getElementById('refiNewAmort').value + ' years',
          newTerm: document.getElementById('refiTerm').value + ' years',
          rateType: document.querySelector('#refiRateTypeToggle .heloc__toggle-btn.active') ? document.querySelector('#refiRateTypeToggle .heloc__toggle-btn.active').textContent : 'Fixed',
          newRate: document.getElementById('refiNewRate').value + '%'
        },
        results: {
          maxMortgage: document.getElementById('resultMaxMortgage').textContent,
          availableEquity: document.getElementById('resultEquity').textContent,
          newMortgageAmount: document.getElementById('resultNewMortgage').textContent,
          currentPayment: document.getElementById('resultCurrentPayment').textContent,
          newPayment: document.getElementById('resultNewPayment').textContent,
          monthlySavings: document.getElementById('resultMonthlySavings').textContent,
          annualSavings: document.getElementById('resultAnnualSavings').textContent,
          termSavings: document.getElementById('resultTermSavings').textContent
        }
      };
    }

    // Specialist form submit
    document.getElementById('specialistForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var name = document.getElementById('specName').value;
      var phone = document.getElementById('specPhone').value;
      var email = document.getElementById('specEmail').value;

      // Gather calculator data for lead notes
      var calcData = typeof getCalculatorData === 'function' ? getCalculatorData() : {};
      var notes = '';
      if (calcData.inputs) {
        notes = Object.keys(calcData.inputs).map(function(k) { return k + ': ' + calcData.inputs[k]; }).join(' | ');
      }
      if (calcData.results) {
        notes += (notes ? ' || Results: ' : 'Results: ') + Object.keys(calcData.results).map(function(k) { return k + ': ' + calcData.results[k]; }).join(' | ');
      }

      (async function() {
        var brokerId = await fetchActiveBrokerId();
        await submitLead({
          first_name: name, last_name: '', email: email, phone: phone,
          source: 'calculator', page: window.location.pathname,
          broker_id: brokerId,
          notes: notes
        });
      })();

      var modalEl = document.getElementById('preApprovalModalInner');
      modalEl.innerHTML = '<button class="modal__close" id="modalCloseLoading" aria-label="Close">&times;</button>' +
        '<div class="help-loading">' +
          '<div class="help-loading__spinner"></div>' +
          '<h2 class="help-loading__text">Pairing you with the best Broker</h2>' +
        '</div>';
      document.getElementById('modalCloseLoading').addEventListener('click', function() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      });
      setTimeout(function() {
        modalEl.innerHTML = '<button class="modal__close" id="modalCloseResult" aria-label="Close">&times;</button>' +
          '<div class="broker-result">' +
            '<h2 class="broker-result__heading">You\'ve Been Matched!</h2>' +
            '<p class="broker-result__subtext">' + name + ', here is your matched broker:</p>' +
            '<img class="broker-result__logo" src="' + broker.logo + '" alt="' + broker.name + '">' +
            '<h3 class="broker-result__name">' + broker.name + '</h3>' +
            '<div class="broker-result__info">' +
              '<span>' + broker.phone + '</span>' +
              '<span>' + broker.licence + '</span>' +
            '</div>' +
            '<a href="tel:' + broker.phoneTel + '" class="btn btn--primary btn--large broker-result__cta">Call Now</a>' +
          '</div>';
        document.getElementById('modalCloseResult').addEventListener('click', function() {
          modal.classList.remove('active');
          document.body.style.overflow = '';
        });
      }, 3000);
    });

    // Navbar scroll shadow
    const navbar = document.getElementById('navbar');
    window.addEventListener('scroll', () => {
      navbar.style.boxShadow = window.scrollY > 10 ? '0 2px 16px rgba(0,0,0,0.06)' : 'none';
    });

    // ===========================
    // Refinance Calculator
    // ===========================
    const MAX_LTV = 0.80;

    const homeValueInput = document.getElementById('refiHomeValue');
    const balanceInput = document.getElementById('refiBalance');
    const currentRateInput = document.getElementById('refiCurrentRate');
    const currentAmortSelect = document.getElementById('refiCurrentAmort');
    const equityToggle = document.getElementById('refiEquityToggle');
    const equityField = document.getElementById('refiEquityField');
    const equityAmountInput = document.getElementById('refiEquityAmount');
    const newAmortSelect = document.getElementById('refiNewAmort');
    const termSelect = document.getElementById('refiTerm');
    const rateTypeToggle = document.getElementById('refiRateTypeToggle');
    const newRateInput = document.getElementById('refiNewRate');

    const currentPaymentDisplay = document.getElementById('refiCurrentPaymentDisplay');
    const newMortgageRow = document.getElementById('refiNewMortgageRow');
    const warningEl = document.getElementById('refiWarning');
    const resultMaxMortgage = document.getElementById('resultMaxMortgage');
    const resultEquity = document.getElementById('resultEquity');
    const resultNewMortgage = document.getElementById('resultNewMortgage');
    const resultCurrentPayment = document.getElementById('resultCurrentPayment');
    const resultNewPayment = document.getElementById('resultNewPayment');
    const resultMonthlySavings = document.getElementById('resultMonthlySavings');
    const resultAnnualSavings = document.getElementById('resultAnnualSavings');
    const resultTermSavings = document.getElementById('resultTermSavings');
    const resultTermLabel = document.getElementById('resultTermLabel');

    // Posted site rates: term (years) → { fixed, variable }
    var SITE_RATES = {
      1: { fixed: 5.99, variable: 4.95 },
      2: { fixed: 4.64, variable: 4.70 },
      3: { fixed: 4.24, variable: 4.55 },
      5: { fixed: 4.04, variable: 4.45 }
    };
    // Populate term dropdown from defaults
    (function() {
      var sel = document.getElementById('refiTerm');
      var terms = Object.keys(SITE_RATES).map(Number).sort(function(a,b){return a-b;});
      sel.innerHTML = terms.map(function(t){return '<option value="'+t+'"'+(t===5?' selected':'')+'>'+t+(t===1?' Year':' Years')+'</option>';}).join('');
    })();
    let rateType = 'fixed';
    let wantsEquity = false;

    function formatCurrency(value) {
      return '$' + Math.round(value).toLocaleString('en-CA');
    }

    function parseCurrency(str) {
      return Number(str.replace(/[^0-9]/g, '')) || 0;
    }

    function bindCurrencyFormat(input) {
      input.addEventListener('input', function() {
        const raw = this.value.replace(/[^0-9]/g, '');
        if (raw === '') { this.value = ''; calculate(); return; }
        this.value = '$' + Number(raw).toLocaleString('en-CA');
        calculate();
      });
    }

    [homeValueInput, balanceInput, equityAmountInput].forEach(bindCurrencyFormat);
    currentRateInput.addEventListener('input', calculate);
    newRateInput.addEventListener('input', calculate);
    currentAmortSelect.addEventListener('change', calculate);
    newAmortSelect.addEventListener('change', calculate);
    termSelect.addEventListener('change', calculate);

    function updateRate() {
      const term = parseInt(termSelect.value);
      const rates = SITE_RATES[term];
      if (rates) {
        newRateInput.value = rates[rateType];
      }
      calculate();
    }

    // Fixed / Variable toggle
    rateTypeToggle.addEventListener('click', function(e) {
      const btn = e.target.closest('.heloc__toggle-btn');
      if (!btn) return;
      rateTypeToggle.querySelectorAll('.heloc__toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      rateType = btn.dataset.value;
      updateRate();
    });

    // Term change also updates rate
    termSelect.removeEventListener('change', calculate);
    termSelect.addEventListener('change', updateRate);

    // Equity toggle
    equityToggle.addEventListener('click', function(e) {
      const btn = e.target.closest('.heloc__toggle-btn');
      if (!btn) return;
      equityToggle.querySelectorAll('.heloc__toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      wantsEquity = btn.dataset.value === 'yes';
      equityField.style.display = wantsEquity ? '' : 'none';
      newMortgageRow.style.display = wantsEquity ? '' : 'none';
      if (!wantsEquity) equityAmountInput.value = '';
      calculate();
    });

    // Standard amortization formula
    function calcMonthlyPayment(principal, annualRate, years) {
      if (principal <= 0) return 0;
      const r = annualRate / 12;
      const n = years * 12;
      if (r === 0) return principal / n;
      return principal * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
    }

    function calculate() {
      const homeValue = parseCurrency(homeValueInput.value);
      const balance = parseCurrency(balanceInput.value);
      const currentRate = parseFloat(currentRateInput.value) / 100 || 0;
      const currentAmort = parseInt(currentAmortSelect.value);
      const equityAmount = wantsEquity ? parseCurrency(equityAmountInput.value) : 0;
      const newAmort = parseInt(newAmortSelect.value);
      const newRate = parseFloat(newRateInput.value) / 100 || 0;
      const term = parseInt(termSelect.value);

      // LTV & equity
      const maxMortgage = Math.round(homeValue * MAX_LTV);
      const availableEquity = Math.max(0, maxMortgage - balance);
      const overLimit = equityAmount > availableEquity && equityAmount > 0 && homeValue > 0;

      // New mortgage = current balance + equity accessed
      const newBalance = balance + equityAmount;

      // Current payment: current balance, current rate, current amortization
      const currentPayment = calcMonthlyPayment(balance, currentRate, currentAmort);
      // New payment: new balance, new rate, new amortization
      const newPayment = overLimit ? 0 : calcMonthlyPayment(newBalance, newRate, newAmort);
      const monthlySavings = overLimit ? 0 : Math.max(0, currentPayment - newPayment);
      const annualSavings = monthlySavings * 12;
      const termSavings = monthlySavings * term * 12;

      // Display
      warningEl.style.display = overLimit ? '' : 'none';

      currentPaymentDisplay.textContent = (balance > 0 && currentRate > 0)
        ? 'Estimated current monthly payment: ' + formatCurrency(currentPayment)
        : 'Estimated current monthly payment: --';

      resultMaxMortgage.textContent = formatCurrency(maxMortgage);
      resultEquity.textContent = formatCurrency(availableEquity);
      resultNewMortgage.textContent = overLimit ? '$0' : formatCurrency(newBalance);
      resultTermSavings.textContent = formatCurrency(termSavings);
      resultTermLabel.textContent = 'over your ' + term + '-year term';
      resultCurrentPayment.textContent = formatCurrency(currentPayment);
      resultNewPayment.textContent = overLimit ? '$0' : formatCurrency(newPayment);
      resultMonthlySavings.textContent = formatCurrency(monthlySavings);
      resultAnnualSavings.textContent = formatCurrency(annualSavings);
    }

    calculate();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../supabase-config.js"></script>
  <script>
    (async function() {
      const rates = await fetchRates('refinance');
      if (rates) {
        SITE_RATES = rates;
        const sel = document.getElementById('refiTerm');
        const terms = Object.keys(rates).map(Number).sort((a, b) => a - b);
        sel.innerHTML = terms.map(t => '<option value="' + t + '"' + (t === 5 ? ' selected' : '') + '>' + t + (t === 1 ? ' Year' : ' Years') + '</option>').join('');
        updateRate();
      }
      const b = await fetchBroker();
      if (b) { broker.name = b.name; broker.phone = b.phone; broker.phoneTel = b.phoneTel; broker.licence = b.licence; broker.logo = '../' + b.logo; }
    })();
  </script>
</body>
</html>
